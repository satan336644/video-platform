datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// USER AUTHENTICATION & PROFILE MODELS
// ============================================================================

enum UserRole {
  VIEWER
  CREATOR
  ADMIN
}

enum ModerationStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  FLAGGED
  REMOVED
}

model User {
  id               String       @id @default(uuid())
  email            String       @unique
  username         String       @unique
  passwordHash     String
  role             UserRole     @default(VIEWER)
  emailVerified    Boolean      @default(false)
  isBanned         Boolean      @default(false)
  suspendedUntil   DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  profile          UserProfile?
  refreshTokens    RefreshToken[]
  videos           Video[]      @relation("CreatorVideos")
  likes            Like[]
  watchHistory     WatchHistory[]
  comments         Comment[]
  followersRel     Follow[]     @relation("FollowTarget")
  followingRel     Follow[]     @relation("Follower")
  notifications    Notification[]
  sentNotifications Notification[] @relation("NotificationActor")
  creatorStats     CreatorStats?
  watchSessions    WatchSession[]
  reportsMade      Report[]     @relation("ReporterReports")
  bans             UserBan[]    @relation("BannedUser")
  bannedUsers      UserBan[]    @relation("AdminBans")

  @@index([email])
  @@index([username])
  @@index([isBanned])
  @@index([suspendedUntil])
}

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  displayName String?
  bio         String?  @db.Text
  avatarUrl   String?
  bannerUrl   String?
  socialLinks Json?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================================================
// VIDEO CATEGORY & TAG MODELS (PHASE 19)
// ============================================================================

enum VideoCategory {
  TRANSGENDER
  SM_BDSM
  FOOT_FETISH
  AMATEUR
  PROFESSIONAL
  SOLO
  COUPLE
  GROUP
  COSPLAY
  ROLEPLAY
  VINTAGE
  POV
  COMPILATION
  INSTRUCTIONAL
  OTHER
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  useCount  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  videos VideoTag[]

  @@index([name])
  @@index([useCount])
  @@index([slug])
}

model VideoTag {
  id        String   @id @default(uuid())
  videoId   String
  tagId     String
  createdAt DateTime @default(now())

  video Video @relation("VideoToTag", fields: [videoId], references: [id], onDelete: Cascade)
  tag   Tag   @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([videoId, tagId])
  @@index([videoId])
  @@index([tagId])
}

// ============================================================================
// VIDEO & MEDIA MODELS
// ============================================================================

enum VideoStatus {
  CREATED
  UPLOADED
  PROCESSING
  READY
  HIDDEN
  FLAGGED
  REMOVED
}

enum VideoVisibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

model Video {
  id                String          @id @default(uuid())
  title             String
  description       String?
  creatorId         String
  creator           User            @relation("CreatorVideos", fields: [creatorId], references: [id], onDelete: Cascade)
  status            VideoStatus     @default(CREATED)
  visibility        VideoVisibility @default(PUBLIC)
  moderationStatus  ModerationStatus @default(PENDING_REVIEW)
  moderatedAt       DateTime?
  moderatedBy       String?
  moderationNotes   String?

  // Phase 19: New category and tag system
  categories        VideoCategory[]
  videoTags         VideoTag[]   @relation("VideoToTag")

  // Phase 19: Keep old fields for backward compatibility (will be deprecated)
  category          String?
  tags              String[]

  viewCount         Int          @default(0)
  likeCount         Int          @default(0)

  sourceObjectKey   String?
  manifestPath      String?
  processedAt       DateTime?

  transcodingJobs   TranscodingJob[]
  likes             Like[]
  watchHistory      WatchHistory[]
  comments          Comment[]
  analytics         VideoAnalytics?
  watchSessions     WatchSession[]
  reports           Report[]
  dmcaTakedowns     DMCATakedown[]

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([creatorId])
  @@index([status])
  @@index([visibility])
  @@index([moderationStatus])
  @@index([moderatedAt])
}

model UploadSession {
  id        String        @id @default(uuid())
  videoId   String
  creatorId String
  status    UploadStatus  @default(PENDING)
  uploadUrl String
  createdAt DateTime      @default(now())
}

enum UploadStatus {
  PENDING
  UPLOADING
  COMPLETED
  FAILED
}

model StoredObject {
  id          String   @id @default(uuid())
  videoId     String
  provider    String
  objectKey   String
  contentType String?
  sizeBytes   Int?
  status      String
  createdAt   DateTime @default(now())

  @@index([videoId])
}

model TranscodingJob {
  id             String   @id @default(uuid())
  videoId        String
  inputObjectKey String
  outputPrefix   String
  status         String
  createdAt      DateTime @default(now())
  completedAt    DateTime?

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
}

model PlaybackTokenUsage {
  tokenId      String   @id
  videoId      String
  issuedAt     DateTime
  usedAt       DateTime
  viewCounted  Boolean  @default(false)

  @@index([videoId])
}

// ============================================================================
// USER ENGAGEMENT MODELS
// ============================================================================

model Like {
  id        String   @id @default(uuid())
  userId    String
  videoId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([videoId])
  @@index([userId])
}

model WatchHistory {
  id             String   @id @default(uuid())
  userId         String
  videoId        String
  lastWatchedAt  DateTime @default(now())
  createdAt      DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId, lastWatchedAt])
  @@index([videoId])
}

model Comment {
  id        String   @id @default(uuid())
  videoId   String
  userId    String
  content   String?
  createdAt DateTime @default(now())

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([userId])
}

model Follow {
  id          String   @id @default(uuid())
  userId      String
  followerId  String
  createdAt   DateTime @default(now())

  user     User @relation("FollowTarget", fields: [userId], references: [id], onDelete: Cascade)
  follower User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)

  @@unique([userId, followerId])
  @@index([userId])
  @@index([followerId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  actorId   String?
  videoId   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  actor User? @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([actorId])
  @@index([videoId])
}

// ============================================================================
// REPORTING & MODERATION MODELS (PHASE 21)
// ============================================================================

enum ReportTarget {
  VIDEO
  COMMENT
  USER
}

enum ReportReason {
  ILLEGAL_CONTENT
  UNDERAGE_CONTENT
  NON_CONSENSUAL
  VIOLENCE
  HATE_SPEECH
  SPAM
  COPYRIGHT
  IMPERSONATION
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

model Report {
  id           String       @id @default(uuid())
  reporterId   String
  targetType   ReportTarget
  targetId     String
  reason       ReportReason
  description  String?
  status       ReportStatus @default(PENDING)
  reviewedBy   String?
  reviewedAt   DateTime?
  resolution   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  reporter     User   @relation("ReporterReports", fields: [reporterId], references: [id], onDelete: Cascade)
  video        Video? @relation(fields: [targetId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([targetId])
  @@index([status])
  @@index([createdAt])
}

model UserBan {
  id         String    @id @default(uuid())
  userId     String
  bannedBy   String
  reason     String
  permanent  Boolean   @default(false)
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())

  user       User @relation("BannedUser", fields: [userId], references: [id], onDelete: Cascade)
  admin      User @relation("AdminBans", fields: [bannedBy], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

enum DMCAStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTER_FILED
}

model DMCATakedown {
  id                 String     @id @default(uuid())
  videoId            String
  claimantName       String
  claimantEmail      String
  claimantAddress    String?
  copyrightWork      String
  infringementUrl    String
  goodFaithStatement Boolean    @default(false)
  accuracyStatement  Boolean    @default(false)
  signature          String
  status             DMCAStatus @default(PENDING)
  reviewedBy         String?
  reviewedAt         DateTime?
  resolution         String?
  createdAt          DateTime   @default(now())

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// CREATOR ANALYTICS & ENGAGEMENT MODELS (PHASE 20)
// ============================================================================

model VideoAnalytics {
  id                String   @id @default(uuid())
  videoId           String   @unique
  totalViews        Int      @default(0)
  totalWatchTime    BigInt   @default(0)        // Total seconds watched across all sessions
  averageWatchTime  Float    @default(0)        // Average seconds per view
  completionRate    Float    @default(0)        // 0-1 (percentage who watched to end)
  engagementScore   Float    @default(0)        // Calculated: views + watch time + likes + comments
  uniqueViewers     Int      @default(0)        // Distinct users who watched
  peakViewerTime    DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([engagementScore])
  @@index([totalViews])
  @@index([updatedAt])
}

model WatchSession {
  id              String    @id @default(uuid())
  userId          String?
  videoId         String
  sessionStart    DateTime  @default(now())
  sessionEnd      DateTime?
  watchDuration   Int       @default(0)        // Seconds actually watched
  percentWatched  Float     @default(0)        // 0-1 (how much of video watched)
  completedVideo  Boolean   @default(false)
  deviceType      String?                      // mobile, desktop, tablet
  userAgent       String?
  ipAddress       String?
  createdAt       DateTime  @default(now())

  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([videoId])
  @@index([userId])
  @@index([sessionStart])
  @@index([completedVideo])
}

model CreatorStats {
  id                    String   @id @default(uuid())
  creatorId             String   @unique
  totalVideos           Int      @default(0)
  totalViews            BigInt   @default(0)
  totalWatchTime        BigInt   @default(0)
  totalLikes            Int      @default(0)
  totalComments         Int      @default(0)
  totalFollowers        Int      @default(0)
  averageEngagement     Float    @default(0)
  topVideo              String?
  lastActivityAt        DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  creator User @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@index([creatorId])
  @@index([totalViews])
  @@index([averageEngagement])
}
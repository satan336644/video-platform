<!DOCTYPE html>
<html>
  <head>
    <title>Video Streaming POC - Tokenized Playback</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      video {
        border: 1px solid #ccc;
        margin: 20px 0;
      }
      .info {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .error {
        color: #d32f2f;
        background: #ffebee;
      }
      .success {
        color: #388e3c;
        background: #e8f5e9;
      }
    </style>
  </head>
  <body>
    <h1>Video Streaming POC - Tokenized Playback</h1>
    
    <div id="status" class="info">Loading...</div>
    <video id="video" controls width="720"></video>

    <script>
      const VIDEO_ID = "6c7904d9-4607-4832-82ca-578eb826c02b"; // Replace with actual video ID
      const API_BASE = "http://localhost:4000/api";

      const statusEl = document.getElementById("status");

      function updateStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.className = `info ${isError ? "error" : "success"}`;
        console.log(message);
      }

      async function playVideo() {
        try {
          if (VIDEO_ID === "PUT_VIDEO_ID_HERE") {
            updateStatus(
              "‚ö†Ô∏è Please replace VIDEO_ID in the HTML with an actual video ID",
              true
            );
            return;
          }

          updateStatus("üîê Step 1: Requesting playback token...");

          // 1Ô∏è‚É£ Get playback token
          const tokenRes = await fetch(
            `${API_BASE}/videos/${VIDEO_ID}/playback-token`,
            { method: "POST" }
          );

          if (!tokenRes.ok) {
            throw new Error(`Token request failed: ${tokenRes.status}`);
          }

          const { playbackToken } = await tokenRes.json();
          console.log("‚úÖ Token acquired:", playbackToken);

          updateStatus("üé¨ Step 2: Requesting protected stream info...");

          // 2Ô∏è‚É£ Request protected stream info
          const streamRes = await fetch(
            `${API_BASE}/videos/${VIDEO_ID}/stream`,
            {
              headers: {
                Authorization: `Bearer ${playbackToken}`,
              },
            }
          );

          if (!streamRes.ok) {
            throw new Error(`Stream request failed: ${streamRes.status}`);
          }

          const { manifestUrl, message } = await streamRes.json();
          console.log("‚úÖ Access granted:", message);
          console.log("‚úÖ Manifest URL:", manifestUrl);

          updateStatus(`‚úÖ ${message} - Initializing player...`);

          // 3Ô∏è‚É£ Initialize HLS player
          const video = document.getElementById("video");
          if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(manifestUrl);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function () {
              console.log("‚úÖ HLS manifest loaded successfully");
              updateStatus(
                "‚úÖ Player ready! (Mock stream - video won't play without real HLS content)"
              );
              video.play().catch((e) => {
                console.log("Auto-play prevented (expected):", e.message);
              });
            });

            hls.on(Hls.Events.ERROR, function (event, data) {
              console.error("‚ùå HLS error:", event, data);
              if (data && data.fatal) {
                updateStatus(
                  `‚ùå HLS error: ${data.type} - ${data.reason}`,
                  true
                );
              }
            });
          } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = manifestUrl;
            updateStatus("‚úÖ Player ready (native HLS support)");
          } else {
            updateStatus("‚ùå HLS.js not supported on this browser", true);
          }
        } catch (error) {
          console.error("‚ùå Playback error:", error);
          updateStatus(`‚ùå Error: ${error.message}`, true);
        }
      }

      // Auto-play on page load
      playVideo();
    </script>
  </body>
</html>
